{% extends "base.html" %}
{% load component_tags %}
{% load fitness_filters %}
{% load humanize %}

{% block title %}Fitness Dashboard{% endblock %}

{% block extra_css %}


<style>
    /* Custom styles to blend pixel art with Material 3 theme */
    :root {

        --theme-surface: #121212;
        --theme-surface-variant: #2a2a2a;
        --theme-on-surface: #E0E0E0;
        --theme-on-surface-variant: #B0B0B0;
        --theme-primary: #00f5d4;
        --theme-on-primary: #000000;
        --theme-secondary: #00bbf9;
        --theme-on-secondary: #000000;
        --theme-tertiary: #ff6b6b; 
        --theme-on-tertiary: #000000;
        --theme-outline: #444;
        --theme-error: #ff4757;
    }

    body {
        font-family: 'Inter', sans-serif;
        background-color: #121212 !important;
        color: #E0E0E0;
    }

    .font-pixel {
        font-family: 'Press Start 2P', cursive;
    }
    .pixel-border {
        border: 4px solid #444;
        box-shadow: 
            inset -4px -4px 0px 0px #222,
            inset 4px 4px 0px 0px #555;
        image-rendering: pixelated;
    }
    .pixel-border-light {
        border: 4px solid #666;
        box-shadow: 
            inset -4px -4px 0px 0px #444,
            inset 4px 4px 0px 0px #888;
        image-rendering: pixelated;
    }    
    .pixel-button {
        border: 4px solid #333;
        background-color: #2a2a2a;
        box-shadow: 
            inset -4px -4px 0px 0px #1a1a1a,
            4px 4px 0px 0px #000000;
        transition: all 0.1s ease-in-out;
    }
    .pixel-button:active {
        transform: translate(4px, 4px); 
        box-shadow: inset -2px -2px 0px 0px #1a1a1a;        
    } 
    html {
        background-color: #121212 !important;
    }
    .nav-icon-active svg {
         filter: drop-shadow(0 0 5px #00f5d4) drop-shadow(0 0 10px #00f5d4);
    }
    .nav-icon-active-desktop {
        background-color: #2a2a2a;
        box-shadow: inset 2px 2px 0px 0px #00f5d444;
    }
    /* Custom progress bar with pixelated look */
    progress{
        -webkit-appearance: none;
        appearance: none;
        width: 100%; 
        height: 20px;
        border: 2px solid #444;
    }

    progress::-webkit-progress-bar {
        background-color: #222;
    }

    progress::-webkit-progress-value {

        background-image: linear-gradient(
                               transparent 33%, rgba(0,0,0,.1) 33%, 
                               rgba(0,0,0,.1) 66%, transparent 66%),
                           linear-gradient(top, 
                               rgba(255, 255, 255, .25),
                               rgba(0, 0, 0, .25) ),
                           linear-gradient(left, #00f5d4, #00bbf9);

        background-size: 35px 20px, 100% 100%, 100% 100%; 
    }    
</style>
{% endblock %}


{% block content %}

<!-- Hidden CSRF token for background sync -->
{% csrf_token %}

<!-- App Container -->
<div class="w-full min-h-screen bg-[#1c1c1c] md:max-w-7xl md:mx-auto md:my-8 md:h-auto md:min-h-[850px] md:rounded-2xl md:shadow-2xl" style="background-color: #121212;">

    <!-- Main Content Area -->
    <div class="flex flex-col w-full min-h-screen">

        <!-- Scrollable Main Content -->
        <main class="flex-1 p-4 overflow-y-auto space-y-6 md:space-y-0 md:grid md:grid-cols-2 md:gap-6 md:p-6">

            <!-- PWA Install Banner -->
            <div class="md:col-span-2 bg-[#2a2a2a]">{% component "pwa_install" %}{% endcomponent %}</div>
            <!-- Left Column -->
            <div class="space-y-6" style="background-color: #121212;">

                <!-- User Profile Card -->
                {% component "level_card" level=12 current_xp=750 next_level_xp=1000 progress_percentage=75 %}{% endcomponent %}

                <!-- Daily Quest / Stats -->
                <section class="space-y-4 bg-[#2a2a2a)">
                    {% component "stat_card" todays_total_calories=todays_total_calories todays_steps=todays_steps todays_lifting_calories=0 %}{% endcomponent %}
                </section>

                <!-- Competitions -->
                <section>
                    {% component "competitions" %}{% endcomponent %}


                </section>

            
                <!-- Existing Chart Components with pixel styling -->
                <section class="pixel-border bg-[#2a2a2a] p-4">
                    {% component "calories_chart_card" %}{% endcomponent %}
                </section>
                <section class="pixel-border bg-[#2a2a2a] p-4">
                    {% component "steps_chart_card" %}{% endcomponent %}
                </section>
                <section class="pixel-border bg-[#2a2a2a] p-4">
                    {% component "sweat_score_chart_card" %}{% endcomponent %}
                </section>

                <!-- Today's Activities Section (if exists) -->
                {% if today_activities %}
                <section class="pixel-border bg-[#2a2a2a] p-4"> 
                    <h2 class="text-xl font-semibold text-theme-on-surface mb-4">Today's Activities</h2> 
                    <div class="space-y-2"> 
                        {% for activity in today_activities %}
                        <div class="flex justify-between items-center p-3 bg-[#333] rounded-lg">
                            <div>
                                <p class="font-medium text-theme-on-surface">{{ activity.name }}</p> 
                                <p class="text-sm text-theme-on-surface-variant">{{ activity.activity_type|title }}</p>
                            </div> 
                            <div class="text-right"> 
                                <p class="text-sm text-theme-on-surface-variant">{{ activity.start_time_utc|time:"H:i" }}</p> 
                                {% if activity.duration_seconds %}
                                <p class="text-sm text-theme-on-surface-variant">{{ activity.duration_seconds|format_duration_seconds }}</p>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </section>
                {% endif %}
            </div>

            <!-- Right Column -->
            <div class="space-y-6" style="background-color: #121212;">                        
                <!-- Virtual Gym Equipment -->
                <section class="bg-[#2a2a2a]">
                    <h3 class="font-pixel text-lg text-center text-gray-300">GYM LOCKER</h3>
                    {% component "gym_locker" slots="[{name': 'Common', 'item': null}, {'name': 'Uncommon', 'item': null}, {'name': 'Rare', 'item': {'name': 'Rare Item', 'description': 'Rare equipment'}}, {'name': 'Epic', 'item': {'name': 'Epic Item', 'description': 'Epic equipment'}}]" %}{% endcomponent %}
                </section>

                <!-- Item Shop -->
                <section>
                    {% component "item_shop" items="[{ 'name': 'Daily Deal', 'description': 'New gear just dropped.', 'price': 100 }]" %}{% endcomponent %}
                </section>

                <!-- Leaderboard -->
                <section class="bg-[#2a2a2a]">
                    {% component "leaderboard" users="[{ 'rank': 1, 'name': 'GIGA', 'score': 5000 }, { 'rank': 2, 'name': 'MAX_P', 'score': 4500 }, { 'rank': 3, 'name': 'RUNC', 'score': 4000 }]" %}{% endcomponent %}
                </section>
            </div>

        </main>
    </div>
    <!-- Main Content Area -->
</div>

<!-- Background sync script -->
<script>
    var garmin_linked = '{{ garmin_linked|yesno:"true,false" }}';  
    var garmin_sync_needed = '{{ garmin_sync_needed|yesno:"true,false" }}';  
    var today = '{{ today|date:"Y-m-d" }}';  
    var yesterday = '{{ yesterday|date:"Y-m-d" }}';  
    var garmin_next_sync = '{{ garmin_next_sync|default:"" }}'; 
    var background_garmin_sync_url = '{% url "fitness:background_garmin_sync" %}';  
    var steps_chart_data_url = '{% url "fitness:steps_chart_data" %}?range=current_month';  
    var sync_garmin_url = '{% url "fitness:sync_garmin" %}';  
    var csrfToken = '{{ csrf_token }}';

    console.log('Garmin linked: ' + garmin_linked);
    console.log('Garmin sync needed: ' + garmin_sync_needed);

    if (garmin_linked) {
        if (garmin_sync_needed) {
            console.log('Background sync script loaded - will trigger sync');    

            // Function to refresh all Garmin data displays
            function refreshGarminData() {
                console.log('Refreshing Garmin data displays...');

                const stepsElement = document.querySelector('.today-steps-display');
                if (stepsElement) {
                    const todaySteps = 15234; // Some calculated value for example
                    if (todaySteps > 0) {
                    stepsElement.innerHTML = `<p class="text-lg text-theme-on-surface">Today's Steps: ${Math.round(todaySteps)}</p>`;         
                    } else {
                    stepsElement.innerHTML = '<p class="text-theme-on-surface-variant">No steps data for today yet.</p>';;         
                    }
                }

                // Refresh activity count
                const activityElement = document.querySelector('.activity-count-display'); 
                if (activityElement) { 
                    const totalActivities = 12; // Some calculated value for example
                    if (totalActivities > 0) {
                    activityElement.innerHTML = `<p class="text-lg text-theme-on-surface">Activities Synced: ${totalActivities}+</p>`;         
                    } else {
                    activityElement.innerHTML = `<p class="text-theme-on-surface-variant">No activities synced yet.</p>`;         
                    }
                }

                // Refresh last sync time
                const syncElement = document.querySelector('.last-sync-display'); 
                if (syncElement)  
                    syncElement.innerHTML = `<p class="text-sm text-theme-on-surface-variant">Last synced: ${new Date().toLocaleString('en-US', { timeZone: 'UTC' })}</p>`; 
                }

                // Make a request to get fresh steps data
                fetch(steps_chart_data_url, {method: 'GET', headers: {'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value}, credentials: 'same-origin' 
                }).then(response => response.json()).then(data => {
                    console.log('Received fresh steps data:', data);

                    // Update today's steps
                    if (stepsElement) {

                        const todayData = data.user_data.find(item => item.date === today);

                        if (todayData) {
                            let todaySteps = todayData.steps; 
                            const yesterdayData = data.user_data.find(item => item.date === yesterday);

                            if (yesterdayData) {
                                todaySteps = todayData.steps - yesterdayData.steps;
                            }

                            if (todaySteps > 0) {
                                stepsElement.innerHTML = `<p class="text-lg text-theme-on-surface">Today's Steps: ${Math.round(todaySteps)}</p>`;        
                            } else {
                                stepsElement.innerHTML = '<p class="text-theme-on-surface-variant">No steps data for today yet.</p>';;         
                            }    
                        } else {
                            stepsElement.innerHTML = `<p class="text-theme-on-surface-variant">No steps data for today yet.</p>`;        
                        }    
                    }

                    // Update activity count (this is approximate based on data length)
                    if (activityElement) {
                        const totalActivities = data.user_data.length; // This is not accurate, but better than nothing
                        if (totalActivities > 0) {
                            activityElement.innerHTML = `<p class="text-lg text-theme-on-surface">Activities Synced: ${totalActivities}+</p>`;         else {
                            activityElement.innerHTML = `<p class="text-theme-on-surface-variant">No activities synced yet.</p>`;         }    
                    }
                }).catch(error => {
                    console.error('Error refreshing steps data:', error);
                    // Revert to original state on error
                    if (stepsElement) {                                   
                        stepsElement.innerHTML = '<p class="text-theme-on-surface-variant">No steps data for today yet.</p>';         }  
                    if (activityElement) {
                        activityElement.innerHTML = `<p class="text-theme-on-surface-variant">No activities synced yet.</p>`;         }    
                });

                // Update last sync time to current time
                if (syncElement) {
                    const now = new Date();
                    const formattedTime = now.toLocaleString('en-US', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });                        
                    syncElement.innerHTML = `<p class="text-sm text-theme-on-surface-variant">Last synced: ${formattedTime}</p>`; 
                }      
            }

            // Trigger background Garmin sync when page loads
            document.addEventListener('DOMContentLoaded', function() {
                console.log('DOM loaded, triggering background Garmin sync...');
                const csrfTokenElement = document.querySelector('[name=csrfmiddlewaretoken]'); 
                if (!csrfTokenElement) {
                    console.error('CSRF token not found!'); 
                    return;
                }

                const csrfTokenValue = csrfTokenElement.value;
                console.log('CSRF token value:', csrfTokenValue);
                console.log('Making POST request to:', background_garmin_sync_url);

                // First try a simple GET request to test if URL is accessible
                console.log('Testing URL accessibility with GET request...'); 
                fetch(background_garmin_sync_url, {
                    method: 'GET', 
                    credentials: 'same-origin' 
                }).then(response => {
                    console.log('GET test response status:', response.status);
                    if (response.status === 405) {
                        console.log('GET not allowed (expected), proceeding with POST');   
                    } else {
                        console.log('GET request succeeded - URL is accessible'); 
                    }   
                }).catch(error => {
                    console.error('GET test failed:', error);					
                });

                // Now make the actual POST request

                // Use FormData for better Django compatibility
                const formData = new FormData();
                formData.append('csrfmiddlewaretoken', csrfTokenValue);
                fetch(background_garmin_sync_url, {
                    method: 'POST',
                    body: formData,
                    credentials: 'same-origin'
                }).then(response => {
                    console.log('Background sync response status:', response.status);
                    console.log('Response headers:', response.headers);
                    if (response.status === 405) {
                        console.error('Method not allowed - URL might not support POST');  
                        return response.text();   
                    }
                    return response.json(); 
                }).then(data => {
                    console.log('Response data:', data);
                    if (typeof data === 'string') {
                        console.error('Got HTML error page instead of JSON:', data);
                        return;
                    }

                    if (data.success) {
                        console.log('Background Garmin sync completed successfully');
                        console.log('Steps synced:', data.steps_synced || 0);
                        console.log('Activities synced:', data.activities_synced || 0);
                        // Refresh the display immediately since sync is complete
                        refreshGarminData();

                    } else if (data.skipped) {
                        console.log('Garmin sync skipped:', data.reason);
                    } else {
                        console.error('Background Garmin sync failed:', data.error);
                    }
                }).catch(error => {
                    console.error('Error triggering background Garmin sync:', error);
                });)),         });
        } else {
            console.log('Background sync not needed - last attempt was recent'); 
            if (garmin_next_sync) 
                console.log('Next sync available at: ' + garmin_next_sync); 
        } 
    } else {
        console.log('Garmin not linked - no background sync script loaded'); 
    }
</script>

<!-- Modal functionality script -->
<script>
    // Modal functionality
    document.addEventListener('DOMContentLoaded', function() {
        const modal = document.getElementById('infoModal');
        const modalContent = document.getElementById('modalContent');
        const closeModal = document.getElementById('closeModal'); 

        // Function to open modal with content
        window.openInfoModal = function(description) {
            if (modal && modalContent) {
                modalContent.innerHTML = description.replace(/\n/g, '<br>'); 
                modal.classList.remove('hidden');
            }
        };

        // Function to close modal
        window.closeInfoModal = function() {
            if (modal) {
                modal.classList.add('hidden'); 
            }    
        };

        // Close modal when clicking close button
        if (closeModal) {
            closeModal.addEventListener('click', closeInfoModal);
        }

        // Close modal when clicking outside
        if (modal) {
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    closeInfoModal();   
                }
            });
        }

        // Close modal on Escape key.
        document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && modal && !modal.classList.contains('hidden')) { 
                    closeInfoModal();    
                }
        });

        // Event delegation for info buttons - removed info-button-specific code for generalization
        document.addEventListener('click', function(e) {
            const infoButton = e.target.closest('[data-description]');
            if (infoButton) {
                const description = infoButton.getAttribute('data-description');
                if (description) openInfoModal(description);
            }
        }); 
    });

    // Garmin Sync Modal functionality
    function openGarminSyncModal() {
        const modal = document.getElementById('garminSyncModal');  
        if (modal) {           
            modal.classList.remove('hidden');
        }    
    }

    function closeGarminSyncModal() {
        const modal = document.getElementById('garminSyncModal');  
        if (modal) {
            modal.classList.add('hidden'); 
        }    
    }

    function selectSyncRange(range) {
        const input = document.getElementById('date-range-input');    
        if (input) {
            input.value = range;          
        }
        closeGarminSyncModal();
        // Submit the form
        const form = document.getElementById('garmin-sync-form');        
        if (form) {
            form.submit('/main');  
        }    
    }

    // Close Garmin sync modal on Escape key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {           
            const modal = document.getElementById('garminSyncModal');           
            if (modal && !modal.classList.contains('hidden')) {
                closeGarminSyncModal();
            }           
        }
    });


</script>

<!-- Info Modal -->
<div id="infoModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-theme-surface rounded-lg shadow-xl max-w-md w-full max-h-[80vh] overflow-y-auto">
            <div class="flex justify-between items-center p-4 border-b border-theme-outline">
                <h3 class="text-lg font-semibold text-theme-on-surface">Information</h3> 
                <button id="closeModal" class="text-theme-on-surface-variant hover:text-theme-on-surface">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6 l12 12" />
                    </svg>
                </button>
            </div>
            <div id="modalContent" class="p-4 text-theme-on-surface"> <!-- Content will be populated by JavaScript --> -->
            </div>
        </div>
    </div>
</div>

<!-- Garmin Sync Modal -->
<div id="garminSyncModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50"> 
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-theme-surface rounded-lg shadow-xl max-w-md w-full">

            <div class="flex justify-between items-center p-4 border-b border-theme-outline">
                <h3 class="text-lg font-semibold text-theme-on-surface">Select Sync Range</h3>
                <button onclick="closeGarminSyncModal()" class="text-theme-on-surface-variant hover:text-theme-on-surface"> <!-- Button changed from pink to green -->
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6 l12 12" />
                    </svg>
                </button>
            </div>
            <div class="p-4 space-y-3"> 
                <button onclick="selectSyncRange('current_month')" class="w-full p-3 bg-theme-surface-variant hover:bg-theme-primary hover:text-theme-on-primary rounded-lg transition-colors text-left">
                    <div class="font-medium">This Month</div>
                    <div class="text-sm text-theme-on-surface-variant">Sync data from the current month</div>
                </button>                
                <button onclick="selectSyncRange('last_3_months')" class="w-full p-3 bg-theme-surface-variant hover:bg-theme-primary hover:text-theme-on-primary rounded-lg transition-colors text-left">
                    <div class="font-medium">Last 3 Months</div>
                    <div class="text-sm text-theme-on-surface-variant">Sync data from the last 3 months</div>
                </button>                  
                <button onclick="selectSyncRange('this_year')" class="w-full p-3 bg-theme-surface-variant hover:bg-theme-primary hover:text-theme-on-primary rounded-lg transition-colors text-left">
                    <div class="font-medium">This Year</div>
                    <div class="text-sm text-theme-on-surface-variant">Sync data from the current year</div>
                </button>
                 <button onclick="selectSyncRange('all_time')" class="w-full p-3 bg-theme-surface-variant hover:bg-theme-primary hover:text-theme-on-primary rounded-lg transition-colors text-left">
                    <div class="font-medium">All Time</div>
                    <div class="text-sm text-theme-on-surface-variant">Sync all available data (10 years)</div>
                </button>
            </div>
        </div> 
    </div>
</div>
{% endblock %}


